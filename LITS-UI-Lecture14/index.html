<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>User Info Samples with Mustache</title>

	<style>
		ul{
			list-style: none;
			padding: 0px;
			overflow: auto;
		}
		li.user{
			border: 1px solid black;
			margin: 10px;
			padding: 20px;
			cursor: pointer;
		}
		li.activeuser{
			background-color: yellow;
			font-weight: bold;
		}
		li.userwithborder{
			border-width: 3px;
		}
		td{
			vertical-align: top;
		}
		.useravater{
			width: 4em;
		}
		.userinfo-block{
			border-left: 2px dotted black;
			padding-left: 0.4em;
		}
		.text-italic{
			font-style: italic;
		}
		.userinfo_likes-list{
			padding-left: 2em;
			list-style: square outside;
		}
		.invisible{
			visibility: hidden;
		}
	</style>
</head>

<body>
	<table>
		<tr>
			<td>
			<h1>User List</h1>
			<ul id="usersList">
				
			</ul>
			</td>
			<td class="userinfo-block">
				<div id="userInfo" class="invisible">
					<h1>{{name}} {{second}}</h1>
					<img src={{avatar}} class="useravater"></img>
					<h3>{{info}}</h3>
					<span class="text-italic">Usualy likes:</span> <ul class="userinfo_likes-list">{{#likes}}<li>{{.}}</li>{{/likes}}</ul>
				</div>
			</td>
		</tr>
	</table>
<p>
<form id='formAdd'>
	Name:
	<input type="text" name="name"></input><p>
	Second:
	<input type="text" name="second"></input><p>
	Info:
	<input type="text" name="info"></input><p>
	Avatar:
	<input type="text" name="avatar"></input><p>
	<input type="submit" value="Add">
	<button type="button" id="getUsers">Get users</button>
</form>
<script type="text/javascript" src="mustache.min.js"></script>
<script type="text/javascript">
		
var usersList = document.getElementById('usersList');

var selectedUser;
var userInfoBlock = document.getElementById('userInfo');
var GlobalTemplate = userInfoBlock.innerHTML;
//var fields = ['name','surname','info','avatar'];

function ApiREST() {
  var _method = "GET";
  var _serverAdress = "http://heedio.me:8383";

  this.setServer = function(address){
  	if (isValidURL(address))
  		_serverAdress = address;
  	else
  		return false;
  	return true;
  }

  function isValidURL(url){
    var RegExp = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;

    if(RegExp.test(url)){
        return true;
    }else{
        return false;
    }
} 

	this.showUsers = function () {
  		var xhr = new XMLHttpRequest();

		xhr.onreadystatechange = function() {
    		if (xhr.readyState == XMLHttpRequest.DONE) 
        		JSON.parse(xhr.responseText).forEach(drawOneUser);
		}

		xhr.open('GET', _serverAdress, true);
		xhr.send();
	}


	this.addElement = function () {
  		var xhr = new XMLHttpRequest();
      
      xhr.open('POST', _serverAdress, true);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		xhr.onreadystatechange = function() {
    		if (xhr.readyState == XMLHttpRequest.DONE && xhr.status ==200) 
        		alert("User added succesfully");
		}

		xhr.send("name="+document.getElementsByName('name')[0].value+"&second="+document.getElementsByName('second')[0].value+"&info="+document.getElementsByName('info')[0].value);
	}

function drawOneUser(content,index){
	var fields = Object.keys(usersList);

 	var el = document.createElement(typeof (tag)!="undefined" ? tag : "li");
	usersList.appendChild(el);
	el.innerHTML = content.name;

	el.classList.add("user");
	//el.classList.add("userwithborder");

	el.onclick = function(){
		this.classList.add("activeuser");
		userInfoBlock.classList.remove("invisible");

		userInfoBlock.innerHTML = Mustache.to_html(GlobalTemplate, content);

		if(selectedUser)
			selectedUser.classList.remove("activeuser");
		selectedUser = this;
	}
	return el;
 }

}
document.getElementById("getUsers").onclick = function(){
	var a = new ApiREST();
	a.showUsers();
}

document.getElementById("formAdd").addEventListener("submit", function(e){
      	e.preventDefault();

      	var a = new ApiREST();
			a.addElement();
});
</script>
</body>
</html>